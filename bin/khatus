#! /bin/bash

set -e

consume() {
    pipe="$1"
    debug="$2"
    bin="$3"
    prefixes_of_net_interfaces_to_show="$4"
    tail -f "$pipe" \
    | stdbuf -o L "$bin"/khatus_controller \
        -v opt_debug="$debug" \
        -v opt_mpd_song_max_chars=10 \
        -v opt_prefixes_of_net_interfaces_to_show="$prefixes_of_net_interfaces_to_show"
}

run_producer() {
    pipe="$1"
    bin="$2"
    cmd="$3"
    msg_head="$4"
    "$bin"/$cmd \
    2> >(
        while read line
        do
            echo "ERROR ${msg_head} $line" > "$pipe"
        done \
    ) \
    | while read line
        do
            echo "OK ${msg_head} $line" > "$pipe"
        done
}

fork_reactor() {
    run_producer "$@" &
}

fork_poller() {
    interval="$1"
    shift
    while :
    do
        run_producer "$@"
        sleep "$interval"
    done &
}

main() {
    declare -A opts=(
        ["--debug"]=0
        ["--dir_bin"]="$HOME/bin"
        ["--file_pipe"]=$(mktemp)
        ["--weather_station_id"]='KJFK'
        ["--screen_brightness_device_name"]='acpi_video0'
        ["--prefixes_of_net_interfaces_to_show"]='w'  # comma-separated
        ["--disk_space_device"]='/'
        ["--disk_io_device"]='sda'
        ["--thermal_zone"]=0
        ["--fan_path"]='/proc/acpi/ibm/fan'
        ["--interval_inp_datetime"]=1
        ["--interval_inp_brightness"]=1
        ["--interval_inp_weather"]=$(( 30 * 60))  # 30 minutes
        ["--interval_inp_mpd_state"]=1
        ["--interval_inp_mpd_song"]=1
        ["--interval_inp_volume"]=1
        ["--interval_inp_bluetooth"]=5
        ["--interval_inp_net_wifi"]=5
        ["--interval_inp_net_io"]=1
        ["--interval_inp_disk_space"]=5
        ["--interval_inp_disk_io"]=1
        ["--interval_inp_loadavg"]=1
        ["--interval_inp_temp"]=1
        ["--interval_inp_fan"]=1
        ["--interval_inp_mem"]=1
    )
    while :
    do
        key="$1"
        val="$2"
        case "$key" in
            '')
                break
                ;;
            * )
                if [ -v opts["$key"] ]
                then
                    if [ "$key" == "--debug" ]
                    then
                        opts["$key"]=1
                        shift
                    elif [ "$val" != "" ]
                    then
                        opts["$key"]="$val"
                        shift
                        shift
                    else
                        echo "Option $key requires an argument" >&2
                        exit 1
                    fi
                else
                    echo "Unknown option: $key" >&2
                    exit 1
                fi
        esac
    done

    (
        echo '=============================================='
        echo "Khatus starting with the following parameters:"
        echo '=============================================='
        for param in ${!opts[@]}
        do
            echo "$param := ${opts[$param]}"
        done \
        | column -ts: \
        | sort
        echo '----------------------------------------------'
    ) >&2

    screen_brightness_device_path='/sys/class/backlight'
    screen_brightness_device_path+="/${opts['--screen_brightness_device_name']}"

    # Just shorthand
    pipe="${opts['--file_pipe']}"
    bin="${opts['--dir_bin']}"

    rm -f "$pipe"
    mkfifo "$pipe"

    cmd_sens_screen_brightness='khatus_sensor_screen_brightness'
    cmd_sens_screen_brightness+=" $screen_brightness_device_path"

    cmd_sens_weather="khatus_sensor_weather ${opts['--weather_station_id']}"
    cmd_sens_disk_space="khatus_sensor_disk_space ${opts['--disk_space_device']}"
    cmd_sens_disk_io="khatus_sensor_disk_io ${opts['--disk_io_device']}"
    cmd_sens_temperature="khatus_sensor_temperature ${opts['--thermal_zone']}"
    cmd_sens_fan="khatus_sensor_fan ${opts['--fan_path']}"
    cmd_sens_bluetooth="khatus_sensor_bluetooth_power $bin"
    cmd_sens_mpd_state="khatus_sensor_mpd_state $bin"
    cmd_sens_net_addr_io="khatus_sensor_net_addr_io $bin"
    cmd_sens_volume="khatus_sensor_volume $bin"

    fork_reactor                                       "$pipe" "$bin" "khatus_sensor_energy $bin"     'in:ENERGY'
    fork_poller "${opts['--interval_inp_datetime']}"   "$pipe" "$bin" khatus_sensor_datetime          'in:DATE_TIME'
    fork_poller "${opts['--interval_inp_brightness']}" "$pipe" "$bin" "$cmd_sens_screen_brightness"   'in:SCREEN_BRIGHTNESS'
    fork_poller "${opts['--interval_inp_weather']}"    "$pipe" "$bin" "$cmd_sens_weather"             'in:WEATHER'
    fork_poller "${opts['--interval_inp_mpd_state']}"  "$pipe" "$bin" "$cmd_sens_mpd_state"           'in:MPD_STATE'
    fork_poller "${opts['--interval_inp_mpd_song']}"   "$pipe" "$bin" khatus_sensor_mpd_song          'in:MPD_SONG'
    fork_poller "${opts['--interval_inp_volume']}"     "$pipe" "$bin" "$cmd_sens_volume"              'in:VOLUME'
    fork_poller "${opts['--interval_inp_bluetooth']}"  "$pipe" "$bin" "$cmd_sens_bluetooth"           'in:BLUETOOTH_POWER'
    fork_poller "${opts['--interval_inp_net_wifi']}"   "$pipe" "$bin" khatus_sensor_net_wifi_status   'in:NET_WIFI_STATUS'
    fork_poller "${opts['--interval_inp_net_io']}"     "$pipe" "$bin" "$cmd_sens_net_addr_io"         'in:NET_ADDR_IO'
    fork_poller "${opts['--interval_inp_disk_space']}" "$pipe" "$bin" "$cmd_sens_disk_space"          'in:DISK_SPACE'
    fork_poller "${opts['--interval_inp_disk_io']}"    "$pipe" "$bin" "$cmd_sens_disk_io"             'in:DISK_IO'
    fork_poller "${opts['--interval_inp_loadavg']}"    "$pipe" "$bin" khatus_sensor_loadavg           'in:LOAD_AVG'
    fork_poller "${opts['--interval_inp_temp']}"       "$pipe" "$bin" "$cmd_sens_temperature"         'in:TEMPERATURE'
    fork_poller "${opts['--interval_inp_fan']}"        "$pipe" "$bin" "$cmd_sens_fan"                 'in:FAN'
    fork_poller "${opts['--interval_inp_mem']}"        "$pipe" "$bin" khatus_sensor_memory            'in:MEMORY'

    consume \
      "$pipe" \
      "${opts['--debug']}" \
      "$bin" \
      "${opts['--prefixes_of_net_interfaces_to_show']}"
}

main $@
